import inspect
import traceback
import builtins
from collections import defaultdict


ALL_DEBUG_CONTEXT = defaultdict(list)


data DebugContext(
    frame_info,
    source_lines: str[],
    extra_info: dict[str, str],
):
    def __init__(self, *args, **kwargs):
        ALL_DEBUG_CONTEXT[self.filename].append(self)
    @property
    def filename(self) = self.frame_info.filename
    @property
    def lineno(self) = self.frame_info.lineno
    @property
    def function(self) = self.frame_info.function
    @property
    def context(self) = self.frame_info.code_context, self.frame_info.index
    @property
    def raw_source(self) = "\n".join(self.source_lines)


def format_vars(vardict) = {
    name: val for name, val in vardict.items()
    if name not in vars(builtins)
} |> repr


def collect_stack_info(stack_level=1):
    cur_frame = inspect.currentframe()
    outer_frame = reduce(
        (frame, _) => frame.f_back,
        range(stack_level),
        cur_frame,
    )

    frame_info = inspect.getframeinfo(outer_frame)
    try:
        source_lines, ==frame_info.lineno = inspect.getsourcelines(outer_frame)
    except OSError:
        source_lines = []

    return DebugContext(
        frame_info=,
        source_lines=,
        extra_info={
            "locals": format_vars(outer_frame.f_locals),
            "globals": format_vars(outer_frame.f_globals),
        }
    )


def collect_exc_info(exc_type, exc_val, exc_tb):
    source_lines, ==exc_tb.lineno = inspect.getsourcelines(exc_tb)
    pretty_tb = traceback.format_exception(exc_type, exc_val, exc_tb) |> "\n".join

    return DebugContext(
        frame_info=exc_tb,
        source_lines=,
        extra_info={
            "traceback": pretty_tb,
        }
    )
