import os
import urllib
import webbrowser
from warnings import warn

from claude_here.debugger import ALL_DEBUG_CONTEXT
from claude_here.prompter import generate_prompt


def get_bool_env_var(env_var, default=None):
    """Get a boolean from an environment variable."""
    boolstr = os.getenv(env_var, "").lower()
    if boolstr in ("true", "yes", "on", "1", "t"):
        return True
    elif boolstr in ("false", "no", "off", "0", "f"):
        return False
    else:
        if boolstr not in ("", "none", "default"):
            warn(f"{env_var} has invalid value {os.getenv(env_var)!r} (defaulting to {default})")
        return default


DEFAULT_MAX_CONTEXT_ITEMS = 10


def launch_claude(project_id=None, max_context_items=None, dry_run=None):
    """Launch claude.ai with all the collected debug context."""
    project_id ??= os.getenv("CLAUDE_HERE_PROJECT_ID", None)
    max_context_items ??= os.getenv("CLAUDE_HERE_MAX_CONTEXT_ITEMS", DEFAULT_MAX_CONTEXT_ITEMS) |> int
    dry_run ??= get_bool_env_var("CLAUDE_HERE_DRY_RUN", False)

    tuple(prompt=prompt, attachment=attachment) = generate_prompt(ALL_DEBUG_CONTEXT, max_context_items=)
    if dry_run:
        print(prompt)
        if attachment:
            print(attachment)
    else:
        webbrowser.open(
            f"https://claude.ai/new?q={urllib.parse.quote_plus(prompt)}"
            + (f"&attachment={urllib.parse.quote_plus(attachment)}" if attachment else "")
            + (f"&project={urllib.parse.quote_plus(project_id)}" if project_id else "")
        )
